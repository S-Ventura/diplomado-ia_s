# -*- coding: utf-8 -*-
"""final_fr&spTraslator.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1uypxtpUUq--gjiMlx6X6qtt-uk6nZe4Z
"""

# üëá Ejecuta esta celda en Google Colab
!pip install -q transformers torch sentencepiece gradio

from transformers import AutoTokenizer, AutoModelForSeq2SeqLM
import gradio as gr
import torch

# Cargar el modelo NLLB-200 (ligero para CPU o GPU)
model_name = "facebook/nllb-200-distilled-600M"
tokenizer = AutoTokenizer.from_pretrained(model_name)

# Verificar y mover el modelo a la GPU si est√° disponible
device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
model = AutoModelForSeq2SeqLM.from_pretrained(model_name).to(device)  # Mover el modelo a la GPU

# C√≥digos de idioma
idiomas = {
    "Espa√±ol ‚Üí Franc√©s": ("spa_Latn", "fra_Latn"),
    "Franc√©s ‚Üí Espa√±ol": ("fra_Latn", "spa_Latn")
}

def traducir(texto, direccion):
    print(f"Texto recibido: {texto}")
    src_lang, tgt_lang = idiomas[direccion]

    # Establecer los idiomas en el tokenizer
    tokenizer.src_lang = src_lang
    tokenizer.tgt_lang = tgt_lang

    # Tokenizar el texto con el idioma de origen
    inputs = tokenizer(texto, return_tensors="pt", padding=True).to(device)

    # Generar la traducci√≥n
    with torch.no_grad():
        generated_tokens = model.generate(
            **inputs,
            max_length=10000,
            num_beams=4,
            forced_bos_token_id=tokenizer.convert_tokens_to_ids(tgt_lang)
        )

    # Decodificar los tokens generados
    traduccion = tokenizer.batch_decode(generated_tokens, skip_special_tokens=True)[0]
    return traduccion

# Prueba con una frase de ejemplo
texto_prueba = "Hola, ¬øc√≥mo est√°s?"
direccion_prueba = "Espa√±ol ‚Üí Franc√©s"

# Llamar a la funci√≥n de traducci√≥n
traduccion_resultado = traducir(texto_prueba, direccion_prueba)
print(f"Traducci√≥n final: {traduccion_resultado}")

# Crear la interfaz de Gradio
interfaz = gr.Interface(
    fn=traducir,
    inputs=[
        gr.Textbox(label="Frase", placeholder="Escribe una frase..."),
        gr.Radio(choices=list(idiomas.keys()), value="Espa√±ol ‚Üí Franc√©s", label="Direcci√≥n de Traducci√≥n")
    ],
    outputs=gr.Textbox(label="Traducci√≥n"),
    title="Traductor Espa√±ol ‚Üî Franc√©s con NLLB",
    description="Traducci√≥n neuronal usando Meta AI (NLLB-200)",
    article="Creado por: **Mayra S√°nchez** y **V√≠ctor Gayt√°n**",
    allow_flagging="never"
)

# Lanzar la interfaz en Colab
interfaz.launch(share = True, inline = True)

